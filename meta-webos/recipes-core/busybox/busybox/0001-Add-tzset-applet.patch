From 1d5fec1abf37ebba469b57632a03229fdc47c88e Mon Sep 17 00:00:00 2001
From: Martin Jansa <martin.jansa@lge.com>
Date: Mon, 6 Nov 2017 17:22:45 +0000
Subject: [PATCH 1/3] Add tzset applet

Signed-off-by: Martin Jansa <martin.jansa@lge.com>
---
 coreutils/Config.src  |  6 ++++++
 coreutils/Kbuild.src  |  1 +
 coreutils/tzset.c     | 47 +++++++++++++++++++++++++++++++++++++++++++++++
 include/applets.src.h |  1 +
 4 files changed, 55 insertions(+)
 create mode 100644 coreutils/tzset.c

diff --git a/coreutils/Config.src b/coreutils/Config.src
index ffbef1a..8151f92 100644
--- a/coreutils/Config.src
+++ b/coreutils/Config.src
@@ -624,6 +624,12 @@ config TTY
 	  tty is used to print the name of the current terminal to
 	  standard output.
 
+config TZSET
+	bool "tzset"
+	default n
+	help
+	  tzset set kernel timezone from userspace
+
 config UNAME
 	bool "uname"
 	default y
diff --git a/coreutils/Kbuild.src b/coreutils/Kbuild.src
index 4ec075a..51b3d9d 100644
--- a/coreutils/Kbuild.src
+++ b/coreutils/Kbuild.src
@@ -72,6 +72,7 @@ lib-$(CONFIG_TAC)       += tac.o
 lib-$(CONFIG_TEE)       += tee.o
 lib-$(CONFIG_TRUE)      += true.o
 lib-$(CONFIG_TTY)       += tty.o
+lib-$(CONFIG_TZSET)     += tzset.o
 lib-$(CONFIG_UNAME)     += uname.o
 lib-$(CONFIG_UNEXPAND)  += expand.o
 lib-$(CONFIG_UNIQ)      += uniq.o
diff --git a/coreutils/tzset.c b/coreutils/tzset.c
new file mode 100644
index 0000000..e8375eb
--- /dev/null
+++ b/coreutils/tzset.c
@@ -0,0 +1,47 @@
+/* -*- compile-command: "cd ../ && make -k"; -*- */
+/*
+ * applet to sync kernel's notion of timezone with userspace's
+ *
+ * by Eric House (eric.house@palm.com)
+ *
+ * Licensed under GPLv2 or later, see file LICENSE in this tarball for details.
+*/
+
+#include <time.h>
+#include <sys/syscall.h>
+
+#include "libbb.h"
+
+#define TZSET_OPT_VERBOSE		0x01 /* -v: */
+
+//usage:#define tzset_trivial_usage
+//usage:      "[v]"
+//usage:#define tzset_full_usage "\n"
+//usage:       "set kernel timezone from userspace"
+//usage:       "\n	-v		Verbose"
+
+
+int
+tzset_main( int argc UNUSED_PARAM, char **argv )
+{
+    bool verbose = false;
+    uint32_t opt = getopt32( argv, "v" );
+	if ( (opt & TZSET_OPT_VERBOSE) != 0 ) {
+        verbose = true;
+    }
+
+    tzset();                    /* set timezone and daylight */
+
+    if ( verbose ) {
+        fprintf( stderr, "Using vals timezone: %ld; daylight: %d\n", 
+                 timezone, daylight );
+    }
+
+	const struct timezone tz = { 
+        .tz_minuteswest = timezone/60 - 60*daylight, 
+        .tz_dsttime = 0 
+    };
+	(void)settimeofday( NULL, &tz );
+
+    return 0;
+}
diff --git a/include/applets.src.h b/include/applets.src.h
index dac83e7..c21b8dd 100644
--- a/include/applets.src.h
+++ b/include/applets.src.h
@@ -363,6 +363,7 @@ IF_TTY(APPLET(tty, BB_DIR_USR_BIN, BB_SUID_DROP))
 IF_TTYSIZE(APPLET(ttysize, BB_DIR_USR_BIN, BB_SUID_DROP))
 IF_TUNCTL(APPLET(tunctl, BB_DIR_SBIN, BB_SUID_DROP))
 IF_TUNE2FS(APPLET(tune2fs, BB_DIR_SBIN, BB_SUID_DROP))
+IF_TZSET(APPLET(tzset, BB_DIR_BIN, BB_SUID_DROP))
 IF_UDHCPC(APPLET(udhcpc, BB_DIR_SBIN, BB_SUID_DROP))
 IF_UDHCPD(APPLET(udhcpd, BB_DIR_USR_SBIN, BB_SUID_DROP))
 IF_UDPSVD(APPLET_ODDNAME(udpsvd, tcpudpsvd, BB_DIR_USR_BIN, BB_SUID_DROP, udpsvd))
-- 
2.7.4

